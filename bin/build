#!/usr/bin/env bash

set -euo pipefail

layers_dir="$1"
env_dir="$2/env"
plan_path="$3"

function _mlserver_layer() {
  local _mlserver_layer = "$layers_dir/$_mlserver_layer"

  # TODO: How to install the repo's source?
  # TODO: Would need to get copied into the buildpack itself?
  pip install mlserver

  cat >"$_mlserver_layer.toml" <<-EOL
  [types]
  launch = true
  cache = true
  EOL
}

function _launch() {
  cat >"$layersdir/launch.toml" <<-EOL
  [[processes]]
  type = "web"
  command = "mlserver start ."
  EOL
}

echo "---> MLServer Buildpack"

echo "---> Installing MLServer"
_mlserver_layer

echo "---> Generating launch.toml"
_launch

exit 0
