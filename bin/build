#!/usr/bin/env bash

set -euo pipefail

layers_dir="$1"
env_dir="$2/env"
plan_path="$3"

function _mlserverLayer() {
  # TODO: If MLServer has been installed already, don't install it again
  local _mlserver_layer="$layers_dir/mlserver"
  local _mlserver_path="$CNB_BUILDPACK_DIR/mlserver"

  # Copy and install all wheels embedded in the buildpack
  cp -r "$_mlserver_path" "$_mlserver_layer"
  pip install "$_mlserver_layer/"*.whl

  cat >"$_mlserver_layer.toml" <<EOF
[types]
  launch = true
  cache = true
EOF
}

function _generateLaunch() {
  cat >"$layers_dir/launch.toml" <<-EOF
[[processes]]
  type = "web"
  command = "mlserver start ."
EOF
}

function _main() {
  echo "---> MLServer Buildpack"

  echo "---> Preparing MLServer layer"
  _mlserverLayer

  echo "---> Generating launch.toml"
  _generateLaunch
}

_main
